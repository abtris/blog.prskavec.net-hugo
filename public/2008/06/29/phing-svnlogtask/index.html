<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  
  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
  

  
  <title>Phing - SvnLogTask</title>

  
  
  <link rel="stylesheet" href="https://blog.prskavec.net/css/hugo-octopress.css">

  
  

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">

  
  <link href="https://blog.prskavec.net/favicon.png" rel="icon">

  
  
  

  

  <meta name="description" content="">
  <meta name="keywords" content="">

  <meta name="author" content="Author&#39;s name">

  
  <meta name="generator" content="Hugo 0.27" />

  
  

</head>
<body>


<header role="banner"><hgroup>
  
  <h1><a href="https://blog.prskavec.net/">Prskavčí blog</a></h1>
    <h2>Subtitle appears under website title</h2>
</hgroup></header>


<nav role="navigation">

<ul class="main-navigation">
  
  
    
      <li><a href="https://blog.prskavec.net/" title="Blog">Blog</a></li>
    
  
    
      <li><a href="https://www.google.com/" title="Google"  target="_blank" >Google</a></li>
    
  
    
      <li><a href="https://www.github.com/parsiya/hugo-octopress" title="This theme on Github"  target="_blank" >This theme on Github</a></li>
    
  
</ul>


<ul class="subscription">
  
    
        <a href="https://blog.prskavec.net/index.xml" target="_blank" type="application/rss+xml" title="RSS"><i class="fa fa-rss-square fa-lg"></i></a>
    
  

</ul>


<form action="https://www.google.com/search" method="get" target="_blank">
  <fieldset role="search">
  	<input class="search" type="text" name="q" results="0" placeholder="Search"/>
    <input type="hidden" name="q" value="site:https://blog.prskavec.net/" />
  </fieldset>
</form>

</nav>


<div id="main">
  <div id="content">
    <div>
      <article class="hentry" role="article">

        
        

<header>
    <p class="meta">Jun 29, 2008
         - 4 minute read 
         - <a href="https://blog.prskavec.net/2008/06/29/phing-svnlogtask/#disqus_thread">Comments</a>

        
    </p>
    <h1 class="entry-title">
         Phing - SvnLogTask 
    </h1>
</header>


        <div class="entry-content">
          
          
          
          
          

<p><a href="http://phing.info/trac/">Phing</a> obsahuje ve verzi 2.3 tyto Tasky pro práci se Subversion.
<ul>
    <li>SvnCheckoutTask</li>
    <li>SvnExportTask</li>
    <li>SvnLastRevisionTask</li>
    <li>SvnUpdateTask</li>
</ul>
To se hodí a také ve svém buildu používám tento postup:
<ol>
    <li>udělám export HEAD revision (SvnExportTask)</li>
    <li>načtu si číslo HEAD revision (SvnLastRevisionTask)</li>
    <li>potom vygeneruju SVN Log (<strong>SvnLogTask</strong>)</li>
    <li>vygeneruju API dokumentaci pro build (PhpDocumentorTask)</li>
    <li>všechno zakomprimuji do souboru s dokumentací a se zdrojáky a uložím kam potřebuju (ZipTask)</li>
</ol>
V postupu je něco co není standardní součástí <a href="http://phing.info/docs/guide/current/">Phingu</a> i když si myslím, že se to tam objeví. Phing pro práci se SVN používá <a href="http://pear.php.net/package/VersionControl_SVN/">VersionControl_SVN</a> 0.3.1 alpha. Bohužel neexistuje zatím stable verze této PEAR knihovny což je škoda, protože funguje celkem dobře a má implementováno vše co potřebuji. Když používáte VersionControl_SVN dá se pracovat s několika návratovými typy:
<ul>
    <li>VERSIONCONTROL_SVN_FETCHMODE_ASSOC,</li>
    <li>VERSIONCONTROL_SVN_FETCHMODE_OBJECT,</li>
    <li>VERSIONCONTROL_SVN_FETCHMODE_XML,</li>
    <li>VERSIONCONTROL_SVN_FETCHMODE_RAW,</li>
    <li>VERSIONCONTROL_SVN_FETCHMODE_ALL,</li>
    <li>VERSIONCONTROL_SVN_FETCHMODE_ARRAY</li>
</ul>
V Phingu se používá, ale výhradně VERSIONCONTROL_SVN_FETCHMODE_ASSOC což není někdy úplně vhodné. V případě, že máte totiž zapnutý přepínač pro výpis v XML je lepší návratový typ VERSIONCONTROL_SVN_FETCHMODE_XML. Proto jsem musel upravit <code>phing\tasks\ext\svn\SvnBaseTask.php</code>.</p>

<p>Tuto část
<pre name='code' class="php">
$options = array(&lsquo;fetchmode&rsquo; =&gt; VERSIONCONTROL_SVN_FETCHMODE_ASSOC, &lsquo;svn_path&rsquo; =&gt; $this-&gt;getSvnPath());
</pre>
jsem nahradil tímto kódem
<pre name='code' class="php">
        // Set up runtime options. Will be passed to all
        // subclasses.
        if ($mode==&ldquo;log&rdquo;)
        {
        $options = array(&lsquo;fetchmode&rsquo; =&gt; VERSIONCONTROL_SVN_FETCHMODE_XML, &lsquo;svn_path&rsquo; =&gt; $this-&gt;getSvnPath());<br />
        }
        else
        {
        $options = array(&lsquo;fetchmode&rsquo; =&gt; VERSIONCONTROL_SVN_FETCHMODE_ASSOC, &lsquo;svn_path&rsquo; =&gt; $this-&gt;getSvnPath());
        }
</pre></p>

<p>Po této úpravě, která jistě by šla udělat lépe. Jsem se dal do psaní vlastního tasku SvnLogTask.php. Task vrátí log z repozitory v XML formátu. Pokud chceme plain text, tak to prožene XSLT transformací a potom ještě vymaže whitespaces z celého dokumentu.
<pre name='code' class="php">
require_once &lsquo;phing/Task.php&rsquo;;
require_once &lsquo;phing/tasks/ext/svn/SvnBaseTask.php&rsquo;;</p>

<p>class SvnLogTask extends SvnBaseTask
{
    private $name = &lsquo;log.xml&rsquo;;
    private $xml = true;
    private $verbose = false;
    /**
     * The setter for the attribute &ldquo;name&rdquo;
     */
    public function setName($str) {
        $this-&gt;name = $str;
    }
    /**
     * The setter for the attribute &ldquo;xml&rdquo;
     */
    public function setXML($str) {
        $this-&gt;xml = $str;
    }<br />
    /**
     * The setter for the attribute &ldquo;verbose&rdquo;
     */
    public function setVerbose($str) {
        $this-&gt;verbose = $str;
    }<br />
    /**
     * The main entry point
     *
     * @throws BuildException
     */
    function main()
    {
        $this-&gt;setup(&lsquo;log&rsquo;);
        $this-&gt;log(&ldquo;Log SVN&rdquo;);</p>

<pre><code>     $switches = array('verbose' =&gt; $this-&gt;verbose);
     $output=$this-&gt;run(array(), $switches);

    $doc = new DOMDocument();
    $doc-&gt;formatOutput = true;        
    $doc-&gt;loadXML($output);             
    // output format 

    if ($this-&gt;xml==&quot;true&quot;)
    {        
      $doc-&gt;save($this-&gt;getToDir().&quot;/&quot;.$this-&gt;name);
    }
    else
    {                 
     // print in plain
     $xsl = new DOMDocument;
     $xsl-&gt;load(dirname(__FILE__).'\LogTxt.xsl');
     $proc = new XSLTProcessor;
     $proc-&gt;importStyleSheet($xsl); // attach the xsl rules
     $output=$proc-&gt;transformToDoc($doc)-&gt;firstChild-&gt;wholeText;

     $pat[0] = &quot;/^\s+/&quot;;
     $pat[1] = &quot;/\s{2,}/&quot;;
     $pat[2] = &quot;/\s+\$/&quot;;
     $rep[0] = &quot;&quot;;
     $rep[1] = &quot; &quot;;
     $rep[2] = &quot;&quot;;
     $after=preg_replace($pat, $rep, $output);
     $str=str_replace(&quot;\\n &quot;,&quot;\n&quot;, $after);         
     file_put_contents($this-&gt;getToDir().&quot;/&quot;.$this-&gt;name,$str);
    }
}
</code></pre>

<p>}
</pre></p>

<p>Potom se to dá už použít v <code>build.xml</code>.
<pre name='code' class="xml">
        &lt;taskdef name=&ldquo;svnlog&rdquo; classname=&ldquo;phing.tasks.ext.svn.SvnLogTask&rdquo; /&gt;
        &lt;svnlog
           svnpath=&ldquo;${svnpath}&rdquo;
           repositoryurl=&ldquo;${rep}&rdquo;
           name=&ldquo;CHANGELOG&rdquo;
           xml=&ldquo;true&rdquo;
           verbose=&ldquo;true&rdquo;
           todir=&ldquo;${tmp}\log&rdquo;/&gt;
</pre></p>

<p>Moje vlastní XSLT transformace (<code>phing\tasks\ext\svn\LogTxt.xsl</code>) na plain text není přiliš vhodná pro nějaké systémové řešení. Lepší je parametr nechat zapnutý. Vzít XML a pomocí XsltFilter aplikovat vlastní transformaci.</p>

<p><pre name='code' class="xml">
&lt;?xml version=&ldquo;1.0&rdquo;?&gt;
&lt;xsl:stylesheet version=&ldquo;1.0&rdquo;
xmlns:xsl=&ldquo;<a href="http://www.w3.org/1999/XSL/Transform&quot;&gt;" target="_blank">http://www.w3.org/1999/XSL/Transform&quot;&gt;</a></p>

<p>&lt;xsl:template match=&ldquo;log&rdquo;&gt;<br />
            CHANGELOG\n
            &lt;xsl:apply-templates select=&lsquo;logentry&rsquo;/&gt;
&lt;/xsl:template&gt;</p>

<p>&lt;xsl:template match=&ldquo;logentry&rdquo;&gt;<br />
            \n R&lt;xsl:apply-templates select=&lsquo;@revision&rsquo;/&gt;\n
            &lt;xsl:apply-templates select=&lsquo;date&rsquo; /&gt; - &lt;xsl:apply-templates select=&lsquo;author&rsquo;/&gt;\n
            &lt;xsl:apply-templates select=&lsquo;msg&rsquo;/&gt;\n<br />
&lt;/xsl:template&gt;</p>

<p>&lt;/xsl:stylesheet&gt;
</pre>
Nakonec přidám ještě moje build.propeties a buid.xml jednoho moje projektu pro ilustraci.</p>

<p><pre name='code' class="bash"></p>

<h1 id="property-files-contain-key-value-pairs">Property files contain key/value pairs</h1>

<h1 id="key-value">key=value</h1>

<p>tmp = c:\tmp
svnpath = c:\apps\svn\bin\svn.exe
rep = file:///rootwww/rep_cvut/akce/trunk
wc =  c:\rootwww\wc_cvut\akce
</pre>
Tady v build.propeties si všimněte jen jediného detailu, ale ten vás může stát hodně času. Cesty k svn a k repozitory neobsahují mezery, pokud máte Subversion např. v Program Files může to nadělat více problémů než užitku a chyby se projevují různě a ne zcela systémově. Doporučuji se tomu předem vyhnout, ušetříte si čas a nervy.
<pre name='code' class="xml">
&lt;?xml version=&ldquo;1.0&rdquo; ?&gt;
&lt;project name=&ldquo;akce2&rdquo; basedir=&ldquo;.&rdquo; default=&ldquo;main&rdquo;&gt;</p>

<pre><code>&amp;lt;!-- Sets the DSTAMP, TSTAMP and TODAY properties --&amp;gt;  
&amp;lt;tstamp/&amp;gt;  

&amp;lt;!-- Load our configuration --&amp;gt;  
&amp;lt;property file=&quot;./build.properties&quot; /&amp;gt;
&amp;lt;taskdef name=&quot;svnlog&quot; classname=&quot;phing.tasks.ext.svn.SvnLogTask&quot; /&amp;gt;

&amp;lt;property name=&quot;package&quot;  value=&quot;${phing.project.name}&quot; override=&quot;true&quot; /&amp;gt;
&amp;lt;property name=&quot;builddir&quot; value=&quot;${tmp}/build/${phing.project.name}&quot; override=&quot;true&quot; /&amp;gt;
&amp;lt;property name=&quot;srcdir&quot;   value=&quot;${project.basedir}&quot; override=&quot;true&quot; /&amp;gt;


&amp;lt;target name=&quot;svn&quot; description=&quot;SVN executes&quot;&amp;gt;
     &amp;lt;!-- Export HEAD copy do /tmp/ --&amp;gt;       
   &amp;lt;svnexport
   svnpath=&quot;${svnpath}&quot;
   repositoryurl=&quot;${rep}&quot;
   force=&quot;yes&quot;
   todir=&quot;${tmp}\export\${phing.project.name}&quot;/&amp;gt;
    &amp;lt;!-- Získání čísla HEAD --&amp;gt;
    &amp;lt;svnlastrevision
       svnpath=&quot;${svnpath}&quot;
       workingcopy=&quot;${wc}&quot;
       propertyname=&quot;svn.lastrevision&quot;/&amp;gt;       
    &amp;lt;!-- Vygenerování aktuálního logu --&amp;gt;           
    &amp;lt;svnlog
       svnpath=&quot;${svnpath}&quot;
       repositoryurl=&quot;${rep}&quot;
       name=&quot;CHANGELOG&quot;
       xml=&quot;false&quot;
       verbose=&quot;true&quot;
       todir=&quot;${tmp}\export\${phing.project.name}&quot;/&amp;gt;    
&amp;lt;/target&amp;gt;

&amp;lt;target name=&quot;phpdoc&quot; description=&quot;API Documentation&quot; depends=&quot;svn&quot;&amp;gt;
    &amp;lt;!-- Generování phpdoc dokumentace --&amp;gt;
    &amp;lt;phpdoc title=&quot;Akce2008 API Documentation&quot;
      destdir=&quot;${builddir}/apidocs&quot;
      sourcecode=&quot;yes&quot;
      defaultpackagename=&quot;Akce2008&quot;
      output=&quot;HTML:default:default&quot;&amp;gt;
       &amp;lt;fileset dir=&quot;${tmp}/export/${phing.project.name}&quot;&amp;gt;
          &amp;lt;include name=&quot;*/*.php&quot; /&amp;gt;      
          &amp;lt;exclude name=&quot;inc/phpmailer/**&quot; /&amp;gt;
          &amp;lt;exclude name=&quot;build/**&quot; /&amp;gt;
       &amp;lt;/fileset&amp;gt;
        &amp;lt;projdocfileset dir=&quot;.&quot;&amp;gt;
              &amp;lt;include name=&quot;CHANGELOG&quot; /&amp;gt;
         &amp;lt;/projdocfileset&amp;gt;           
    &amp;lt;/phpdoc&amp;gt;
  &amp;lt;/target&amp;gt;

    &amp;lt;!-- Fileset for all files --&amp;gt;
    &amp;lt;fileset dir=&quot;${tmp}/export/${phing.project.name}&quot; id=&quot;allfiles&quot;&amp;gt;
        &amp;lt;include name=&quot;**&quot; /&amp;gt;
        &amp;lt;exclude name=&quot;build.xml&quot; /&amp;gt;
        &amp;lt;exclude name=&quot;build.properties&quot; /&amp;gt;
    &amp;lt;/fileset&amp;gt;

&amp;lt;!-- Main Target --&amp;gt;
&amp;lt;target name=&quot;main&quot; description=&quot;main target&quot; depends=&quot;phpdoc&quot;&amp;gt;
    &amp;lt;!-- Zdrojové kódy pro příslušnou revizi --&amp;gt;
    &amp;lt;zip destfile=&quot;${builddir}/${phing.project.name}-R${svn.lastrevision}-${DSTAMP}${TSTAMP}.zip&quot; basedir=&quot;${tmp}/export/${phing.project.name}&quot; /&amp;gt;                    
    &amp;lt;!-- Vygenerovanou dokumentaci přesunu do ZIP s číslem příslušné revize --&amp;gt;
    &amp;lt;zip destfile=&quot;${builddir}/${phing.project.name}-apidocs-R${svn.lastrevision}-${DSTAMP}${TSTAMP}.zip&quot; basedir=&quot;${builddir}/apidocs&quot; /&amp;gt;        
    &amp;lt;!-- Smazaní temp adresáře --&amp;gt;
    &amp;lt;delete dir=&quot;${builddir}/apidocs&quot; includeemptydirs=&quot;true&quot; verbose=&quot;true&quot; failonerror=&quot;true&quot; /&amp;gt;

&amp;lt;/target&amp;gt;
</code></pre>

<p>&lt;/project&gt;
</pre>
Vlastní build se pustí pomocí <code>phing</code> z příkazové řádky tam kde máte <code>build.xml</code> uložený. Pokud se nedaří Phing nainstalovat a nakonfigurovat pro chod např. s PHPDoc, tak doporučuji postup ze stránek Phingu.
<pre name='code' class="bash">
pear channel-discover pear.phing.info
pear install -a phing/phing
pear install channel://pear.php.net/VersionControl_SVN-0.3.1
</pre>
Doufám, že někomu rady budou k užitku, Phing je skvělý produkt i když většina asi dá za přednost <a href="http://ant.apache.org/">Antu</a> pokud nedělají čistě PHP.</p>

        </div>
        

<footer>
  <p class="meta">
    <span class="byline author vcard">Posted by <span class="fn">Author&#39;s name</span></span>
    
    <time>Jun 29, 2008</time>
    
      <span class="categories">
        Tags:
        
          <a class="category" href="https://blog.prskavec.net/tags/phing">phing</a>  <a class="category" href="https://blog.prskavec.net/tags/php">php</a>  <a class="category" href="https://blog.prskavec.net/tags/subversion">subversion</a>  
    
    </span>
  </p>

  
  

  

  <p class="meta">
    
        <a class="basic-alignment left" href="https://blog.prskavec.net/2008/06/23/assembla-svn-a-trac-pro-kazdho/" title="Assembla: SVN a Trac pro každého">Assembla: SVN a Trac pro každého</a>
    

    
      <a class="basic-alignment right" href="https://blog.prskavec.net/2008/07/01/netbeans-pdt-a-subversion-15/" title="NetBeans, PDT a Subversion 1.5">NetBeans, PDT a Subversion 1.5</a>
    
  </p>
  
    
      <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'prskavecblog';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
  
</footer>

      </article>
    </div>
    

<aside class="sidebar thirds">
  <section class="first odd">

    
      <h1>Sidebar Header</h1>
    

    <p>
      
        Here&rsquo;s a <a href="https://www.google.com" target="_blank">link to google</a>
  </br>
  Second line
  </br>
  Third line
  This line has two spaces in the end to create a new line using markdown
  Forth line
      
    </p>
  </section>



  
  <ul class="sidebar-nav">
    <li class="sidebar-nav-item">
      <a target="_blank" href="https://github.com/abtris/" title="https://github.com/abtris/"><i class="fa fa-github fa-3x"></i></a>
      <a target="_blank" href="https://bitbucket.org/abtris/" title="https://bitbucket.org/abtris/"><i class="fa fa-bitbucket fa-3x"></i></a>
      
      <a target="_blank" href="https://twitter.com/abtris/" title="https://twitter.com/abtris/"><i class="fa fa-twitter fa-3x"></i></a>
      <a target="_blank" href="https://keybase.io/abtris/" title="https://keybase.io/abtris/"><i class="fa fa-key fa-3x"></i></a> 
      
      
      
      
      
      

    
    
    </li>
  </ul>

  

  
    
      <section class="odd">
        
          <h1>Sidebar Links</h1>
        
        
          <li>
            <a href="https://blog.prskavec.net/categories/hugo/" title="Hugo" >Hugo</a>
          </li>
        
          <li>
            <a href="https://blog.prskavec.net/" title="Homepage" >Homepage</a>
          </li>
        
          <li>
            <a href="https://www.google.com" title="Google" >Google</a>
          </li>
        
      </section>
    
  

  
  
  
    
      <section class="even">
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
          
            <li class="post">
              <a href="/2017/06/28/jam-stack/">JAM stack</a>
            </li>
          
            <li class="post">
              <a href="/2017/04/21/docker-multi-stage-build/">Docker - multi stage build</a>
            </li>
          
            <li class="post">
              <a href="/2016/12/20/jenkins-declarative-pipelines/">Jenkins Declarative Pipelines</a>
            </li>
          
            <li class="post">
              <a href="/2016/10/31/jenkins-2-dot-0-novinky-a-vylepseni-2-dot-cast/">Jenkins 2.0 - novinky a vylepšení - 2.část</a>
            </li>
          
            <li class="post">
              <a href="/2016/10/26/jenkins-2-dot-0-novinky-a-vylepseni/">Jenkins 2.0 - novinky a vylepšení</a>
            </li>
          
        </ul>
      </section>
    
  

</aside>

  </div>
</div>

<footer role="contentinfo">
  <p>Copyright &copy; 2017 Author&#39;s name - <a href="https://blog.prskavec.net/license/">License</a> -
  <span class="credit">Powered by <a target="_blank" href="https://gohugo.io">Hugo</a> and <a target="_blank" href="https://github.com/parsiya/hugo-octopress/">Hugo-Octopress</a> theme.
</p>

</footer>


</body>
</html>

